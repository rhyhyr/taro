<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>음성 인식 키워드 추출</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-pulse { animation: pulse 1.5s infinite; }
    .animate-rotate { animation: rotate 2s linear infinite; }
    .recording .outer-circle { border-color: #ef4444; }
    .recording .inner-circle { background-color: #ef4444; }
  </style>
</head>
<body class="bg-white flex flex-col items-center min-h-screen">
  <div class="flex flex-col items-center justify-center flex-1">
    <div id="recordButton" class="relative w-16 h-16 mb-8 cursor-pointer">
      <div class="outer-circle absolute inset-0 border-4 border-black rounded-full"></div>
      <div class="inner-circle absolute inset-0 m-3 bg-black rounded-full"></div>
    </div>
    <p id="recognitionStatus" class="text-xl font-medium text-center mb-8">도착지를 말하려면 원형을 클릭하세요</p>
    <div id="resultContainer" class="w-full max-w-md px-4 mb-8 hidden">
      <p class="text-sm text-gray-500 mb-2">전체 인식 텍스트:</p>
      <div id="recognitionResult" class="p-3 bg-gray-100 rounded-md min-h-16 text-center"></div>
    </div>
  </div>
  
  <div class="w-full px-4 mb-8">
    <div class="w-full border border-blue-500 rounded-md flex overflow-hidden h-14">
      <input 
        id="messageInput"
        type="text" 
        class="flex-1 h-full px-4 outline-none font-bold text-lg" 
        placeholder="도착지를 입력해주세요."
      />
      <button id="sendButton" class="w-24 h-full border-l border-blue-500 flex items-center justify-center text-blue-500 font-medium">
        전송
      </button>
    </div>
  </div>

  <script>
    const GEMINI_API_KEY = 'AIzaSyAL71nBFGMto1bp1mz0LaR-vXPmWx6nK1E';
    
    // DOM 요소
    const recordButton = document.getElementById('recordButton');
    const recognitionStatus = document.getElementById('recognitionStatus');
    const resultContainer = document.getElementById('resultContainer');
    const recognitionResult = document.getElementById('recognitionResult');
    const messageInput = document.getElementById('messageInput');
    
    /**
     * Gemini API를 호출하여 텍스트에서 도착지를 추출하는 함수
     * @param {string} text - 음성으로 인식된 텍스트
     * @returns {Promise<string|null>} - 추출된 도착지 또는 null
     */
    async function extractDestinationWithGemini(text) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

      const prompt = `
        사용자의 문장에서 '도착지'만 정확하게 추출해줘.
        결과는 반드시 {"destination": "추출된 도착지"} 형식의 JSON으로만 응답해야 해.
        만약 문장에 도착지가 없으면 {"destination": null} 로 응답해줘.

        사용자 문장: "${text}"
      `;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
          }),
        });

        if (!response.ok) {
          throw new Error('API 호출 실패: ' + response.statusText);
        }

        const data = await response.json();
        const resultText = data.candidates[0].content.parts[0].text;
        
        // Gemini 응답에서 JSON 부분만 깔끔하게 정리
        const jsonString = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
        const resultJson = JSON.parse(jsonString);

        return resultJson.destination;

      } catch (error) {
        console.error('Gemini API 오류:', error);
        recognitionStatus.textContent = 'AI 모델 호출 중 오류가 발생했습니다.';
        return null; // 오류 발생 시 null 반환
      }
    }

    // 음성 인식 객체 설정
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;

    if (!SpeechRecognition) {
      recognitionStatus.textContent = "이 브라우저는 음성 인식을 지원하지 않습니다.";
    } else {
      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.interimResults = false;
      recognition.continuous = false;

      recordButton.addEventListener('click', () => isRecording ? recognition.stop() : recognition.start());

      recognition.onstart = () => {
        isRecording = true;
        recordButton.classList.add('recording', 'animate-rotate');
        recordButton.querySelector('.inner-circle').classList.add('animate-pulse');
        recognitionStatus.textContent = "도착지를 말씀하세요...";
        messageInput.value = '';
        messageInput.placeholder = '음성 인식 중...';
      };

      recognition.onend = () => {
        isRecording = false;
        recordButton.classList.remove('recording', 'animate-rotate');
        recordButton.querySelector('.inner-circle').classList.remove('animate-pulse');
        recognitionStatus.textContent = "도착지를 말하려면 원형을 클릭하세요";
        messageInput.placeholder = '추출된 도착지가 여기에 표시됩니다';
      };

      recognition.onerror = (event) => {
        console.error("음성 인식 오류:", event.error);
        recognitionStatus.textContent = "오류가 발생했습니다: " + event.error;
      };

      // 음성 인식 결과 처리 (가장 중요한 부분)
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        
        // 전체 인식 결과 보여주기
        recognitionResult.textContent = transcript;
        resultContainer.classList.remove('hidden');
        recognitionStatus.textContent = 'AI가 도착지를 분석 중입니다...';

        // Gemini API로 도착지 추출
        const destination = await extractDestinationWithGemini(transcript);
        
        if (destination) {
          messageInput.value = destination; // 추출된 도착지를 입력창에 표시
          recognitionStatus.textContent = '도착지 추출 완료!';
        } else {
          messageInput.value = ''; // 도착지가 없으면 비워둠
          recognitionStatus.textContent = '인식된 문장에 도착지가 없습니다.';
        }
      };
    }
 	// 전송 버튼 클릭 이벤트
    sendButton.addEventListener('click', () => {
      if (messageInput.value.trim() !== '') {
        // 입력된 텍스트를 localStorage에 저장
        localStorage.setItem('userInputText', messageInput.value);
        
        // 확인 페이지로 이동
        window.location.href = `/test`;
      }
    });
    
    // 엔터 키 이벤트
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && messageInput.value.trim() !== '') {
        sendButton.click();
      }
    });
  
  </script>
</body>
</html>