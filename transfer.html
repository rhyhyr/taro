<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì¤‘êµí†µ í™˜ìŠ¹ ì •ë³´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .bus-position {
      transition: transform 0.5s ease-in-out, left 0.5s ease-in-out;
    }
    .progress-dot {
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
  </style>
</head>
<body class="bg-white flex flex-col items-center min-h-screen p-4">
  <div class="max-w-md w-full">
    <div class="flex items-center justify-end mb-4">
      <span class="text-xl font-bold" id="totalTime">0ë¶„</span>
    </div>
    <div class="relative mb-8 px-4">
      <div class="absolute -top-8 bus-position" id="busIcon" style="left: calc(0% - 12px);">
        <span class="text-2xl">ğŸšŒ</span>
      </div>
      <div class="flex items-center justify-between" id="progressContainer"></div>
    </div>
    <div class="text-center mb-8">
      <p id="walkInstruction"></p>
    </div>
    <div class="text-center mb-4" id="busInfo">
      <p class="text-3xl font-bold">
        <span id="busNumber">-</span> ìŠ¹ì°¨
      </p>
    </div>
    <div class="text-center mb-8" id="destInfo">
      <p class="text-2xl font-bold">
        <span id="destination">-</span> í•˜ì°¨
      </p>
    </div>
    <div class="flex gap-4 mb-8" id="buttonGroup">
  		<button id="listenBtn" class="flex-1 py-4 border border-blue-500 rounded-md text-blue-500 font-medium hover:bg-blue-50 transition-colors">ë“£ê¸°</button>
  		<button id="transferBtn" class="flex-1 py-4 bg-blue-500 rounded-md text-white font-medium hover:bg-blue-600 transition-colors">í™˜ìŠ¹</button>
	</div>
    <div class="text-center mb-4">
      <p class="text-lg">í•˜ì°¨ í›„, í™˜ìŠ¹ ëˆ„ë¥´ì„¸ìš”</p>
    </div>
    <div class="text-center mb-4">
      <p class="text-gray-500">
        <span id="distanceTime">0ë¶„</span> ê±°ë¦¬ì—
        <span id="fasterTime">0ë¶„</span> ë¹ ë¥¸ ê²½ë¡œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
      </p>
    </div>
    <div class="w-full flex justify-center">
      <button id="viewRouteBtn" class="text-blue-500 border-b border-blue-500 pb-1 hover:text-blue-600 transition-colors">ê²½ë¡œ ë³´ê¸°</button>
    </div>
  </div>

<script th:inline="javascript">
let currentStep = 0;
let routeSteps = [];
let recommendedSteps = [];
let bestTotalPath = null; // ìµœì  ê²½ë¡œ ì „ì²´ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜ ì¶”ê°€
let recommendedTotalPath = null; // ì¶”ì²œ ê²½ë¡œ ì „ì²´ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜ ì¶”ê°€
let bestTotalTime = 0;
let recommendedTime = 0;
let isShowingRecommendedRoute = false; // í˜„ì¬ ì¶”ì²œ ê²½ë¡œë¥¼ ë³´ì—¬ì£¼ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì 

//ë°°í¬ëœ Cloud Functionì˜ URL
const TTS_FUNCTION_URL = 'https://asia-northeast3-taro-461003.cloudfunctions.net/googleTts';


function setCurrentStation(station, isWalk = false) {
  const el = document.getElementById('walkInstruction');
  if (isWalk) {
    el.innerHTML = `<p class='text-2xl font-bold text-blue-700'>${station}</p>`;
  } else {
    el.innerHTML = `<p class='text-lg font-bold text-xl'>í˜„ì¬ <span id='currentStation'>${station}</span></p>`;
  }
}

// busType ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
function setBusNumber(number, busType) {
  const busNumberSpan = document.getElementById('busNumber');
  busNumberSpan.textContent = number + 'ë²ˆ';
  
  // ëª¨ë“  ê°€ëŠ¥í•œ ìƒ‰ìƒ í´ë˜ìŠ¤ ë° ê´€ë ¨ëœ í´ë˜ìŠ¤ ì œê±°
  busNumberSpan.classList.remove('text-blue-600', 'text-red-600', 'text-green-600', 'text-gray-900', 'bus-number-color');

  // bustypeì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
  switch (busType) {
    case 'ì¼ë°˜ë²„ìŠ¤':
      busNumberSpan.classList.add('text-blue-600'); // íŒŒë€ìƒ‰
      break;
    case 'ê¸‰í–‰ë²„ìŠ¤':
    case 'ì‹¬ì•¼ë²„ìŠ¤(ê¸‰í–‰)':
      busNumberSpan.classList.add('text-red-600'); // ë¹¨ê°„ìƒ‰
      break;
    case 'ë§ˆì„ë²„ìŠ¤':
      busNumberSpan.classList.add('text-green-600'); // ì´ˆë¡ìƒ‰
      break;
    default:
      busNumberSpan.classList.add('text-gray-900'); // ê¸°ë³¸ ìƒ‰ìƒ (ê²€ì •)
      break;
  }
}
function setDestination(dest) {
  document.getElementById('destination').textContent = dest;
}
function setTotalTime(time) {
  document.getElementById('totalTime').textContent = time + 'ë¶„';
}
function moveBusIcon(step) {
  const busIcon = document.getElementById('busIcon');
  const dots = document.querySelectorAll('.progress-dot');
  if (dots.length < 2) return;
  const percent = (step - 1) / (dots.length - 1) * 100;
  busIcon.style.left = `calc(${percent}% - 12px)`;
}
function updateProgressDots(step) {
  const dots = document.querySelectorAll('.progress-dot');
  dots.forEach((dot, index) => {
    if (index < step) {
      dot.className = 'w-4 h-4 rounded-full bg-black progress-dot';
    } else {
      dot.className = 'w-4 h-4 rounded-full border-2 border-gray-300 bg-white progress-dot';
    }
  });
}
function setupDots(count) {
  const container = document.getElementById('progressContainer');
  container.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const dot = document.createElement('div');
    dot.className = 'w-4 h-4 rounded-full border-2 border-gray-300 bg-white progress-dot';
    dot.id = `dot${i}`;
    container.appendChild(dot);
    if (i < count - 1) {
      const bar = document.createElement('div');
      bar.className = 'flex-1 h-0.5 bg-gray-300 mx-2';
      container.appendChild(bar);
    }
  }
  updateProgressDots(1);
}

function renderStep(step) {
  if (step >= routeSteps.length) return;
  const sub = routeSteps[step];
  currentStep = step;
  updateProgressDots(step + 1);

  if (sub.trafficType === 2) { // ë²„ìŠ¤
	  setCurrentStation(sub.startName);
	  setDestination(sub.endName);
	  setBusNumber(sub.lane[0].busNo, sub.busType); 
	  document.getElementById('busInfo').style.display = 'block';
	  document.getElementById('destInfo').style.display = 'block';
	  document.getElementById('listenBtn').style.display = 'inline-block';

	  // í™˜ìŠ¹ ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ
	  const transferBtn = document.getElementById('transferBtn');
	  transferBtn.classList.remove('w-full');
	  transferBtn.classList.add('flex-1');

	} else if (sub.trafficType === 3) { // ë„ë³´
	  const next = routeSteps[step + 1];
	  setCurrentStation(`${sub.distance}m ê±°ë¦¬ì— ìˆëŠ” ${next?.startName || 'ë‹¤ìŒ ì •ë¥˜ì¥'}ë¡œ ê°€ì„¸ìš”.`, true);
	  document.getElementById('busInfo').style.display = 'none';
	  document.getElementById('destInfo').style.display = 'none';
	  document.getElementById('listenBtn').style.display = 'none';

	  // í™˜ìŠ¹ ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬
	  const transferBtn = document.getElementById('transferBtn');
	  transferBtn.classList.remove('flex-1');
	  transferBtn.classList.add('w-full');
	}


  // í™˜ìŠ¹ ë²„íŠ¼ê³¼ ê´€ë ¨ ë©”ì‹œì§€ ê°€ì‹œì„± ê´€ë¦¬
  if (currentStep === routeSteps.length - 1) {
    document.getElementById('transferBtn').style.display = 'none';
    document.querySelector('.text-center.mb-4 > p.text-lg').style.display = 'none'; // "í•˜ì°¨ í›„, í™˜ìŠ¹ ëˆ„ë¥´ì„¸ìš”" ë©”ì‹œì§€ ìˆ¨ê¹€
  } else {
    document.getElementById('transferBtn').style.display = 'block';
    document.querySelector('.text-center.mb-4 > p.text-lg').style.display = 'block'; // "í•˜ì°¨ í›„, í™˜ìŠ¹ ëˆ„ë¥´ì„¸ìš”" ë©”ì‹œì§€ í‘œì‹œ
  }
}

window.addEventListener('DOMContentLoaded', async () => {
  const startx = /*[[${startx}]]*/ 0;
  const starty = /*[[${starty}]]*/ 0;
  const endx = /*[[${x}]]*/ 0;
  const endy = /*[[${y}]]*/ 0;

  const odsayKey = "sKjjRgwggOCqUOMBz6omJ9L0diWbh0WucBzr/O45OU0";
  const busanServiceKey = 'AkitlNBJDUtLzeFfwjIH1dYllDkQN70sg4eveRlW8Vz8E6C3OCL%2Bh%2F4bn6SB0CK2cw9H8LoWgzzkp9njYDw7mA%3D%3D';

  const url = `https://api.odsay.com/v1/api/searchPubTransPathT?SX=${startx}&SY=${starty}&EX=${endx}&EY=${endy}&SearchPathType=2&apiKey=${odsayKey}`;
  const res = await fetch(url);
  const data = await res.json();

  const paths = data.result?.path?.slice(0, 4);
  const busArrivalCache = new Map();

  const scoredPaths = await Promise.all(paths.map(async (path) => {
    let walkTime = 0, transfers = path.info.busTransitCount, minArrival = Infinity;
    let isValid = true;
    let subPathsWithBusType = []; 

    for (const sub of path.subPath) {
      if (sub.trafficType === 3) {
        walkTime += sub.sectionTime;
        subPathsWithBusType.push(sub); 
      } else if (sub.trafficType === 2) {
        const busNo = sub.lane[0].busNo;
        const stationId = sub.startLocalStationID;
        const cacheKey = `${stationId}_${busNo}`;
        let arrivalData; 

        if (busArrivalCache.has(cacheKey)) {
          arrivalData = busArrivalCache.get(cacheKey);
        } else {
          arrivalData = await getMinArrivalTime(stationId, busNo, busanServiceKey);
          busArrivalCache.set(cacheKey, arrivalData);
        }

        // arrivalDataê°€ nullì´ê±°ë‚˜ min1ì´ nullì¸ ê²½ìš° ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ ì²˜ë¦¬
        if (arrivalData === null || arrivalData.min1 === null) {
          isValid = false;
          break; 
        }
        
        // sub ê°ì²´ì— busType ì •ë³´ ì¶”ê°€ (spread ì—°ì‚°ìë¡œ ê¸°ì¡´ sub ì†ì„± ìœ ì§€)
        subPathsWithBusType.push({ ...sub, busType: arrivalData.busType }); 

        if (arrivalData.min1 < minArrival) minArrival = arrivalData.min1;
      }
    }
    return {
      path: { ...path, subPath: subPathsWithBusType }, 
      walkTime, transfers, minArrival, totalTime: path.info.totalTime, isValid
    };
  }));

  const validPaths = scoredPaths.filter(p => p.isValid);
  if (validPaths.length === 0) {
    alert("ë„ì°© ì •ë³´ê°€ ìˆëŠ” ìœ íš¨í•œ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const best = validPaths.sort((a, b) => {
	    if (a.transfers !== b.transfers) return a.transfers - b.transfers;
	    if (a.walkTime !== b.walkTime) return a.walkTime - b.walkTime;
	    return a.minArrival - b.minArrival;
  })[0];

  const fastest = validPaths.reduce((a, b) => a.totalTime < b.totalTime ? a : b, validPaths[0]);
  const showRecommended = fastest.path.info.totalTime !== best.path.info.totalTime && fastest.path.info.totalTime < best.path.info.totalTime;

  bestTotalTime = best.totalTime;
  bestTotalPath = best.path; 
  if (showRecommended) {
    recommendedSteps = fastest.path.subPath;
    recommendedTime = fastest.totalTime;
    recommendedTotalPath = fastest.path; 
    document.getElementById("distanceTime").textContent = `${recommendedSteps[0]?.distance || 0}m`; 
    document.getElementById("fasterTime").textContent = `${best.totalTime - fastest.totalTime}ë¶„`;
    document.querySelector('.text-gray-500').style.display = 'block'; 
    document.getElementById("viewRouteBtn").style.display = 'block'; 
  } else {
    document.querySelector('.text-gray-500').style.display = 'none'; 
    document.getElementById("viewRouteBtn").style.display = 'none'; 
  }

  applyRoute(best.path);
});

document.getElementById('viewRouteBtn').addEventListener('click', () => {
  const recommendationTextContainer = document.querySelector('.text-gray-500');
  const viewRouteBtn = document.getElementById('viewRouteBtn');

  if (!isShowingRecommendedRoute) { 
    if (recommendedTotalPath) { 
      applyRoute(recommendedTotalPath);
      isShowingRecommendedRoute = true;
      viewRouteBtn.textContent = 'ì´ì „ ê²½ë¡œ'; 
      recommendationTextContainer.style.display = 'block';
      recommendationTextContainer.textContent = `${bestTotalTime - recommendedTime}ë¶„ ë¹ ë¥¸ ê²½ë¡œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    } else {
      alert('ë” ë¹ ë¥¸ ì¶”ì²œ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
  } else { 
    if (bestTotalPath) { 
      applyRoute(bestTotalPath);
      isShowingRecommendedRoute = false;
      viewRouteBtn.textContent = 'ê²½ë¡œ ë³´ê¸°'; 
      if (recommendedTotalPath && bestTotalTime > recommendedTime) { 
        document.getElementById("distanceTime").textContent = `${recommendedTotalPath.subPath[0]?.distance || 0}m`; 
        document.getElementById("fasterTime").textContent = `${bestTotalTime - recommendedTime}ë¶„`;
        recommendationTextContainer.innerHTML = `<span id="distanceTime">${recommendedTotalPath.subPath[0]?.distance || 0}m</span> ê±°ë¦¬ì— <span id="fasterTime">${bestTotalTime - recommendedTime}ë¶„</span> ë¹ ë¥¸ ê²½ë¡œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.`;
        recommendationTextContainer.style.display = 'block';
      } else { 
        recommendationTextContainer.style.display = 'none';
        viewRouteBtn.style.display = 'none'; 
      }
    } else {
      alert('ì´ì „ ê²½ë¡œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }
});


document.getElementById('transferBtn').addEventListener('click', () => {
  if (currentStep < routeSteps.length - 1) {
    renderStep(currentStep + 1);
    moveBusIcon(currentStep + 1);
    document.querySelector('.text-gray-500').style.display = 'none';
    document.getElementById("viewRouteBtn").style.display = 'none';
  } else {
    alert("ëª¨ë“  í™˜ìŠ¹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.getElementById('transferBtn').style.display = 'none';
    document.querySelector('.text-center.mb-4 > p.text-lg').style.display = 'none'; 
    document.querySelector('.text-gray-500').style.display = 'none';
    document.getElementById("viewRouteBtn").style.display = 'none';
  }
});

function getMinArrivalTime(stationId, busNo, serviceKey) {
  const url = `https://apis.data.go.kr/6260000/BusanBIMS/stopArrByBstopid?bstopid=${stationId}&serviceKey=${serviceKey}`;
  return fetch(url)
    .then(res => res.text())
    .then(xmlStr => {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlStr, "application/xml");
      const items = [...xml.getElementsByTagName("item")];
      const match = items.find(item => getText(item, "lineno") === busNo);
      
      if (!match) return null; 

      const min1 = parseInt(getText(match, "min1"));
      const busType = getText(match, "bustype"); 
      console.log("ë²„ìŠ¤ ë²ˆí˜¸:", busNo, "ë²„ìŠ¤ íƒ€ì…:", busType);


      return isNaN(min1) ? null : { min1: min1, busType: busType }; 
    }).catch(() => null);
}

function getText(parent, tagName) {
  const el = parent.getElementsByTagName(tagName)[0];
  return el ? el.textContent : "ì •ë³´ ì—†ìŒ";
}

//ë“£ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('listenBtn').addEventListener('click', async function() {
  this.disabled = true;
  this.textContent = 'ìŒì„± ìƒì„± ì¤‘...';

  const station = document.getElementById('currentStation').textContent;
  const bus = document.getElementById('busNumber').textContent;
  const dest = document.getElementById('destination').textContent;
  const textToSpeak = `í˜„ì¬ ì •ë¥˜ì¥ì€ ${station}ì…ë‹ˆë‹¤. ${bus}ì„ íƒ‘ìŠ¹ í›„ ${dest}ì—ì„œ í•˜ì°¨í•˜ì„¸ìš”.`;

  console.log('ìŒì„± ë³€í™˜ ìš”ì²­:', textToSpeak);

  try {
    const response = await fetch(TTS_FUNCTION_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: textToSpeak }),
    });

    if (!response.ok) {
      throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
    }

    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    audio.play();

    audio.onended = () => {
      this.disabled = false;
      this.textContent = 'ë“£ê¸°';
      URL.revokeObjectURL(audioUrl);
    };

  } catch (error) {
    console.error('TTS ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
    alert('ìŒì„±ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    this.disabled = false;
    this.textContent = 'ë“£ê¸°';
  }
});

function applyRoute(path) {
	  let filteredSubPaths = [...path.subPath];

	  // 1. ë§ˆì§€ë§‰ ë„ë³´ êµ¬ê°„ ì œê±°
	  if (filteredSubPaths.length > 0 && filteredSubPaths[filteredSubPaths.length - 1].trafficType === 3) {
	    filteredSubPaths.pop();
	  }

	  // 2. ê±°ë¦¬ 3 ì´í•˜ì˜ ë„ë³´ êµ¬ê°„ ì œê±°
	  filteredSubPaths = filteredSubPaths.filter(sub =>
	    !(sub.trafficType === 3 && sub.distance <= 3)
	  );

	  setTotalTime(path.info.totalTime);
	  routeSteps = filteredSubPaths;
	  setupDots(routeSteps.length);
	  renderStep(0);

	  if (routeSteps.length > 0 && currentStep < routeSteps.length - 1) {
	    document.getElementById('transferBtn').style.display = 'block';
	    document.querySelector('.text-center.mb-4 > p.text-lg').style.display = 'block';
	  } else {
	    document.getElementById('transferBtn').style.display = 'none';
	    document.querySelector('.text-center.mb-4 > p.text-lg').style.display = 'none';
	  }
	}

</script>
</body>
</html>